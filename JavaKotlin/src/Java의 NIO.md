## Java의 NIO (New Input/Output)

### 질문
**1. 자바의 NIO란 무엇이며, 기존의 IO와 비교했을 때 어떤 장점이 있는지 설명해주세요.**

    NIO는 New Input/Output으로 기존 IO를 개선하기 위해 등장했습니다.
    Java는 IO를 위한 시스템 콜을 사용할 때, 버퍼를 통해 파일 읽기를 처리하기 때문에 내부 버퍼로 복사할 때 Blocking이 발생하여 비효율적이었습니다. 
    NIO는 시스템 메모리에 직접 접근할 수 있는 Buffer 클래스와 Channel, Selector를 활용하여 효율적인 IO 작업이 가능합니다.

**2. NIO에서 Buffer 클래스는 어떤 역할을 하며, Channel과 Selector는 어떤 차이점이 있는지 설명해주세요.**
    
    NIO의 버퍼 클래스는 Direct Buffer를 이용하여 직접 시스템 메모리에 데이터를 복사할 수 있어 읽고/쓰기 효율을 높여줍니다.
    Channel은 버퍼 클래스와 함께 작업하여, 시스템 메모리의 버퍼에 직접적으로 데이터를 읽고 쓸 수 있습니다. 
    반면 Selector는 여러 개의 Channel 중 준비 완료된 Channel을 선택하는 방법을 제공하여, 단 한 개의 스레드로 수 천가지 동시 작업을 진행할 수 있게 합니다.


### Java의 시스템 콜

`시스템 콜`은 커널 영역의 서비스를 이용하기 위한 인터페이스임.

`C`에서는 `malloc` 같은 명령어로 내부적으로 시스템 콜을 발생시켜 운영체제에 위임을 요청함.

단순히 메모리 할당 뿐만 아니라 I/O 작업이나 네트워크 작업 등 커널 영역이 필요한 모든 곳에서 시스템 콜이 필요함.

그래서 `Java`에서 시스템 콜을 많이 이용하는 부분은 I/O 작업임.
하지만 Java는 `JVM` 위에서 동작하기 때문에 시스템 콜 자체가 느려질 수 있음.

**C와 Java의 시스템 콜 과정**
1. C: C 프로세스 -> 시스템 콜 -> 커널 -> 디스크 컨트롤러 -> 데이터 복사
2. Java: JVM -> 시스템 콜 -> 커널 -> 디스크 컨트롤러 -> 커널 버퍼 복사 -> JVM 버퍼 복사

즉, Java는 시스템 콜을 사용하기 위해 내부적으로 네이티브 메서드를 활용하고,
버퍼를 통해 파일 읽기를 처리하기 때문에 내부 버퍼로 복사할 때 Blocking이 발생함.

때문에 `Java IO는 느리다`란 얘기가 나왔고, 이를 개선하기 위해 `NIO` 패키지가 등장했음.

<br>

### IO 향상을 위한 OS 수준의 기술

**1. 버퍼 (Buffer)**

버퍼는 데이터를 하나씩 반복적으로 전달하는 것보다 중간에 버퍼를 두고,
그 버퍼에 데이터를 모아 한 번에 효율적으로 전달하기 위해 사용됨.

**2. Scatter/Gather**

만약 버퍼를 N개 만들어 사용하는데 동시에 IO 작업이 이뤄진다면,
N번의 시스템 콜이 일어날 수 있고 이는 비효율적이다.

이런 문제를 해결하기 위해 내부적으로 호출할 때마다 사용할 버퍼의 주소 목록을 넘겨주어,
주어진 버퍼들로부터 순차적으로 읽거나 씀.

<br>

### Java에서 Blocking IO와 None-Blocking IO의 차이

**1. Java의 포인터 버퍼 도입**

JVM은 하나의 프로세스이기 때문에 IO가 비효율적이고, Blocking되며 OS가 제공하는 기능들을 사용하지 못함.

그래서 NIO에서는 커널에 의해 관리되는 `시스템 메모리`를 직접 사용할 수 있는 `Buffer` 클래스가 도입되었음.

**2. 네이티브 IO 서비스 채널 도입**

NIO는 기존 단방향 스트림에서 `채널(Channel)`을 도입하여 양방향 통신이 가능하게 됨.

채널은 버퍼 클래스와 함께 작업하고, 이를 통해 시스템 메모리 버퍼에 직접적으로 데이터를 읽고 쓸 수 있게 됨.
또 Scatter, Gather를 구현해서 IO 작업을 보다 효율적으로 처리할 수 있게 됨.

**3. Selector 도입**

NIO는 Selector를 이용하여 단 한 개의 스레드로 수 천가지 동시 사용자를 처리할 수 있게 됨.

<br>

### Java NIO의 동작 원리

**1. 바이트 코드 (ByteBuffer)**

바이트 버퍼는 시스템 메모리를 직접 사용하는 `DirectBuffer`를 만들 수 있는 버퍼 클래스임.

바이트 버퍼를 이용하는 NIO의 IO 과정은, JVM -> 시스템 콜 -> JNI -> 디스크 컨트롤러 -> DMA -> 복사

기존 IO에서는 데이터가 커널 영역의 버퍼로 전송되고, 다시 JVM의 버퍼로 옮기는 이중 작업이 발생함.

NIO에서는 다이렉트로 시스템 메모리에 복사를 할 수 있음. 그래서 `바이트 버퍼`가 중요한 것임.

|           | 장점                        | 단점                         |
|-----------|---------------------------|----------------------------|
| 다이렉트 버퍼   | 읽고 쓰기가 빠름                 | 시스템 메모리를 사용해서 할당/해제 비용이 비쌈 |
| 논 다이렉트 버퍼 | Heap 영역에 생성되어 할당/해제 비용이 쌈 | 두 번의 버퍼를 거쳐 읽고 쓰기가 느림      |

**2. 채널 (Channel)**

기존 파일이나 소켓에서 사용하던 스트림을 네이티브 IO 서비스를 이용할 수 있도록 도와줌.

`ScatteringByteChannel`과 `GatheringByteChannel`을 이용해서 OS가 지원하는 네이티브 IO 서비스인 Scatter/Gather를 사용할 수 있음.

이를 통해, 시스템 콜과 커널 영역에서 프로세스 영역으로 버퍼 복사를 줄여주거나 완전히 없애줄 수 있음.